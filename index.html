<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calistenia PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bibliotecas para Geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* --- PALETA DE CORES E ESTILOS GERAIS (PRETO E PRATA) --- */
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain;
            background-color: #121212; /* Preto principal */
            color: #E0E0E0; /* Prata/Cinza claro para texto */
            overflow-x: hidden; /* Prevenir scroll horizontal causado por animações de slide */
        }
        #appContainer {
            background-color: #1E1E1E; /* Cinza escuro para container principal */
            color: #E0E0E0;
            position: relative;
            overflow-x: hidden;
        }

        /* --- ESTILOS DAS TELAS PARA ANIMAÇÃO --- */
        #loginScreen, #homeScreen, #workoutListScreen, #workoutPreviewScreen, #workoutExecutionScreen, #summaryScreen {
            width: 100%;
        }


        /* --- ANIMAÇÕES PARA TRANSIÇÃO DE TELA --- */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @keyframes slideInFromRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutToLeft {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(-100%); opacity: 0; }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .animate-fade-out {
            animation: fadeOut 0.3s ease-in forwards;
        }
        .animate-slide-in-right {
            animation: slideInFromRight 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        .animate-slide-out-left {
            animation: slideOutToLeft 0.3s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards;
        }


        .app-header {
            background-color: #000000;
            color: #A0A0A0;
            padding: 1rem;
            text-align: center;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .app-header h1 {
            font-family: 'Archivo Black', sans-serif;
            font-size: 1.875rem; /* 30px */
            font-weight: 400;
            letter-spacing: 0.025em;
            text-transform: uppercase;
            line-height: 1.2;
        }
        .pro-text-header {
            font-weight: 400;
            color: #FFFFFF;
        }
        .app-header .subtitle { /* Estilo para "por Pedro Dias" */
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            color: #B0B0B0;
            margin-top: 0.1rem;
            letter-spacing: 0.025em;
            display: block;
            text-transform: none;
        }
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1E1E1E;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #555555;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #777777;
        }
        .action-button { /* Classe base para botões com interação */
            transition: all 0.15s ease-out;
        }
        .action-button:active {
            transform: scale(0.97) translateY(1px);
        }

        /* Classe genérica para botões 3D */
        .button-3d {
            border-width: 1px;
            border-style: solid;
            /* A cor da borda e da sombra será definida por variáveis CSS ou especificamente */
            box-shadow: 0 2px 0 var(--shadow-color-dark, #222), /* Sombra inferior principal com fallback */
                        0 3px 4px rgba(0,0,0,0.2);    /* Sombra suave geral */
        }
        .button-3d:hover {
            box-shadow: 0 1px 0 var(--shadow-color-dark, #222), /* Sombra inferior menor no hover */
                        0 2px 3px rgba(0,0,0,0.25);
        }
        .button-3d:active {
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.25); /* Sombra interna ao pressionar */
            transform: translateY(2px) scale(0.98);
        }


        .media-display-area {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            aspect-ratio: 16 / 9;
            border-radius: 0.5rem;
            background-color: #333333;
            overflow: hidden;
        }
        .video-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background-color: #121212;
            color: #E0E0E0;
            border: 1px solid #333333;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.3s ease-in-out;
            font-size: 0.9rem;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .toast.hide {
            opacity: 0;
            transform: translateX(-50%) translateY(20px);
        }

        .timer-display-and-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            width: 100%;
            padding: 0 1rem;
        }
        #circularTimerContainer {
            width: 180px;  /* Aumentado */
            height: 180px; /* Aumentado */
            margin: 0 0.5rem;
        }
        #circularTimerText {
            font-size: 3rem; 
            color: #E0E0E0;
        }
        #progressRing {
            transition: stroke-dashoffset 0.3s linear;
        }

        #pauseRestTimerBtn, #skipRestTimerBtn {
            padding: 0;
            font-size: 0.70rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 9999px;
            width: 60px;  
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            border: none;
        }

        #pauseRestTimerBtn {
            background-color: #B0B0B0;
            color: #121212;
            box-shadow: -4px -4px 8px rgba(180, 180, 180, 0.08),
                         4px  4px 8px rgba(0, 0, 0, 0.4);        
        }
        #pauseRestTimerBtn:hover {
            background-color: #A0A0A0;
             box-shadow: -5px -5px 10px rgba(180, 180, 180, 0.1),
                         5px  5px 10px rgba(0, 0, 0, 0.45);
        }
        #pauseRestTimerBtn:active {
            background-color: #909090;
            box-shadow: inset -3px -3px 6px rgba(0, 0, 0, 0.35),
                        inset  3px  3px 6px rgba(180, 180, 180, 0.06);
        }

        #skipRestTimerBtn {
            background-color: #4D4D4D;
            color: #E0E0E0;
            box-shadow: -4px -4px 8px rgba(90, 90, 90, 0.25),
                         4px  4px 8px rgba(0, 0, 0, 0.5);    
        }
        #skipRestTimerBtn:hover {
            background-color: #585858;
            box-shadow: -5px -5px 10px rgba(90, 90, 90, 0.3),
                         5px  5px 10px rgba(0, 0, 0, 0.55);
        }
        #skipRestTimerBtn:active {
            background-color: #404040;
            box-shadow: inset -3px -3px 6px rgba(0, 0, 0, 0.5),    
                        inset  3px  3px 6px rgba(90, 90, 90, 0.2);
        }


        .exercise-card {
            background-color: #2C2C2C;
            color: #E0E0E0;
            padding: 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            margin-bottom: 1rem;
        }
        .exercise-details-info {
            background-color: #1E1E1E;
            border: 1px solid #333333;
            color: #B0B0B0;
            padding: 0.5rem;
            border-radius: 0.5rem;
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .exercise-details-info strong {
            color: #E0E0E0;
        }
        .series-display-text {
            font-size: 2rem;
            font-weight: 700;
            color: #CCCCCC;
            text-transform: uppercase;
            margin-bottom: 0.5rem !important;
        }


        #seriesInputArea label, #loginScreen label, #pseInputArea label, #observationInputArea label {
            font-weight: 500;
            color: #B0B0B0;
        }
        #repsInput, #loginName, #loginPassword, #pseInput, #observationInput, .superset-reps-input { 
            background-color: #1E1E1E;
            color: #E0E0E0;
            border: 1px solid #444444;
        }
        #repsInput::placeholder, #loginName::placeholder, #loginPassword::placeholder, #pseInput::placeholder, #observationInput::placeholder, .superset-reps-input::placeholder { 
            color: #888888;
        }
        #repsInput:focus, #loginName:focus, #loginPassword:focus, #pseInput:focus, #observationInput:focus, .superset-reps-input:focus { 
            border-color: #A0A0A0;
            box-shadow: 0 0 0 2px rgba(160, 160, 160, 0.3);
        }
        #seriesInputArea {
            padding-left: 0;
            padding-right: 0;
            margin-bottom: 0.75rem;
        }
        #pseInputArea {
            margin-top: 1rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background-color: #2C2C2C;
            border-radius: 0.5rem;
        }
        #pseInputArea p {
            font-size: 0.8rem;
            color: #A0A0A0;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        
        /* Botões 3D - Concluir Série e Pular Exercício */
        #completeSeriesBtn {
            background-color: #145A32;  
            color: #FFFFFF;
            border-color: #0B5345;
            --shadow-color-dark: #0B5345;
        }
        #completeSeriesBtn:hover {
            background-color: #0B5345;
        }
        #completeSeriesBtn:active {
            background-color: #07352B;
        }

        .skip-exercise-btn {
            background-color: #7B241C;  
            color: white;
            border-color: #641E16;
            --shadow-color-dark: #641E16;
        }
        .skip-exercise-btn:hover {
            background-color: #641E16;
        }
        .skip-exercise-btn:active {
            background-color: #4B120E;
        }
        
        #loginButton {
            background-color: #1A5D1A;
            color: #FFFFFF;
            border-color: #113C11;
            --shadow-color-dark: #113C11;
        }
        #loginButton:hover {
             background-color: #113C11;
        }
         #loginButton:active {
             background-color: #0A270A;
        }

        #homeScreen button,
        #workoutButtonsContainer button {
            background-color: #374151;
            color: #F3F4F6;
            border-color: #1F2937;
            --shadow-color-dark: #1F2937;
        }
        #homeScreen button:hover,
        #workoutButtonsContainer button:hover {
            background-color: #4B5563;
        }
         #homeScreen button:active,
        #workoutButtonsContainer button:active {
            background-color: #1F2937;
        }

        .nav-button {
            background-color: #4B5563;
            color: #E0E0E0;
            border-color: #2D3748;
            --shadow-color-dark: #1A202C;
            padding: 0.6rem 1.1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
        }
        .nav-button:hover {
            background-color: #2D3748;
        }
        .nav-button:active {
            background-color: #1A202C;
        }
        .nav-button svg {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
        }
        
        /* Botão Salvar Resumo - Dourado Escuro */
        #concludeAndGoHomeBtn { 
            background-color: #B08D57; 
            color: #FFFFFF; 
            border-color: #8C6D41; 
            --shadow-color-dark: #8C6D41; 
        }
        #concludeAndGoHomeBtn:hover {
            background-color: #8C6D41;
        }
        #concludeAndGoHomeBtn:active {
            background-color: #79552B;
        }

        /* Botão Download PDF - Azul */
        #downloadPdfBtn {
            background-color: #0284c7; 
            color: #FFFFFF;
            border-color: #0369a1; 
            --shadow-color-dark: #075985; 
        }
        #downloadPdfBtn:hover {
            background-color: #0369a1;
        }
        #downloadPdfBtn:active {
            background-color: #075985;
        }


        #finishWorkoutBtn {
            background-color: #7D3C98;
            color: #FFFFFF;
            border-color: #5B2C6F;
            --shadow-color-dark: #5B2C6F;
        }
        #finishWorkoutBtn:hover {
            background-color: #5B2C6F;
        }
         #finishWorkoutBtn:active {
            background-color: #4A235A;
        }


        #workoutSummaryContent h4, #workoutStats h3, #pseInputArea h4 {
            color: #E0E0E0;
        }
        #workoutSummaryContent .bg-gray-800,
        #workoutStats .bg-gray-700 {
            background-color: #1E1E1E;
            color: #B0B0B0;
        }
        #workoutSummaryContent .bg-gray-800 strong,
        #workoutStats .bg-gray-700 strong {
            color: #E0E0E0;
        }
        #motivationalMessage {
            color: #2ECC71;
        }
        .force-hidden {
            display: none !important;
        }
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(18, 18, 18, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1050;
            color: white;
            font-size: 1.2rem;
        }
        #exerciseActionButtons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col items-center justify-start min-h-screen pt-4 px-2 sm:px-4">

    <div id="appContainer" class="w-full max-w-xl bg-gray-800 shadow-xl rounded-lg overflow-hidden relative">

        <div id="fixedHeader" class="app-header hidden">
             <h1>CALISTENIA <span class="pro-text-header">PRO</span></h1>
        </div>

        <div id="loginScreen" class="p-6 hidden">
             <div class="app-header mb-6">
                 <h1>CALISTENIA <span class="pro-text-header">PRO</span>
                     <span class="subtitle">por Pedro Dias</span>
                 </h1>
             </div>
            <h2 class="text-2xl font-bold text-gray-300 mb-6 text-center">Seja bem-vindo,<br>identifique-se</h2>
            <div class="space-y-4">
                <div>
                    <label for="loginName" class="block text-sm font-medium mb-1">Nome:</label>
                    <input type="text" id="loginName" class="w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-gray-500 focus:border-gray-500 text-base bg-gray-700 text-gray-100" placeholder="Seu nome completo">
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium mb-1">Senha de Acesso:</label>
                    <input type="password" id="loginPassword" class="w-full p-3 border border-gray-600 rounded-lg shadow-sm focus:ring-gray-500 focus:border-gray-500 text-base bg-gray-700 text-gray-100" placeholder="Senha do mês">
                </div>
                <button id="loginButton" onclick="loginUser()" class="w-full font-semibold py-3 px-6 rounded-lg action-button button-3d text-base mt-8">Entrar</button>
            </div>
        </div>

        <div id="homeScreen" class="text-center hidden">
            <div class="app-header">
                <h1>CALISTENIA <span class="pro-text-header">PRO</span>
                </h1>
            </div>
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-300 my-6" style="font-family: 'Inter', sans-serif;">Escolha seu nível</h2>
                <div class="space-y-4">
                    <button id="level-iniciante" onclick="selectLevel('iniciante')" class="w-full font-semibold py-4 px-6 rounded-lg action-button button-3d">
                        Iniciante
                        <span class="block text-sm font-normal opacity-80">(0 pull ups e 0 push ups)</span>
                    </button>
                    <button id="level-intermediario" onclick="selectLevel('intermediario')" class="w-full font-semibold py-4 px-6 rounded-lg action-button button-3d">
                        Intermediário
                        <span class="block text-sm font-normal opacity-80">(1+ pull ups e 1+ dips)</span>
                    </button>
                    <button id="level-avancado" onclick="selectLevel('avancado')" class="w-full font-semibold py-4 px-6 rounded-lg action-button button-3d">
                        Avançado
                        <span class="block text-sm font-normal opacity-80">(10+ barras e 15+ dips)</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="workoutListScreen" class="p-6 hidden">
            <button onclick="showScreen(Screens.HOME); resetAppState(false);" class="nav-button mb-6 action-button button-3d">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                Voltar para Níveis
            </button>
            <div id="workoutButtonsContainer" class="space-y-3 mt-4">
            </div>
        </div>

        <div id="workoutPreviewScreen" class="p-6 hidden">
            <button onclick="showScreen(Screens.WORKOUT_LIST);" class="nav-button mb-6 action-button button-3d">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                Voltar
            </button>
            <div id="previewContent" class="space-y-4"></div>
            <button id="startWorkoutBtn" class="w-full mt-6 font-semibold py-3 px-6 rounded-lg action-button button-3d text-base" style="background-color: #1A5D1A; color: #FFFFFF; border-color: #113C11; --shadow-color-dark: #113C11;">Iniciar Treino</button>
        </div>

        <div id="workoutExecutionScreen" class="p-6 hidden">
             <button onclick="confirmExitWorkout()" class="nav-button mb-4 action-button button-3d">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" /></svg>
                Voltar para Treinos
            </button>
            
            <div id="exerciseContainer" class="exercise-card">
                 <!-- CONTEÚDO SERÁ GERADO DINAMICAMENTE PELO JAVASCRIPT -->
            </div>
        </div>

        <div id="summaryScreen" class="p-6 hidden text-center">
            <div id="workoutSummaryContent" class="bg-gray-700 p-4 rounded-lg shadow-md mb-4 text-left mt-6">
            </div>
            <div id="workoutStats" class="bg-gray-700 p-4 rounded-lg shadow-md mb-4 text-left">
            </div>

            <div id="pseInputArea" class="text-left mb-4">
                <h4 class="text-lg font-semibold mb-1 text-gray-100">Percepção de Esforço (PSE)</h4>
                <p class="text-xs text-gray-400 mb-2">
                    Numa escala de 1 (muito, muito leve) a 10 (esforço máximo absoluto),
                    qual foi sua percepção geral de esforço para este treino?
                </p>
                <label for="pseInput" class="block text-sm font-medium text-gray-300 mb-1">Sua PSE (1-10):</label>
                <input type="number" id="pseInput" min="1" max="10" class="w-full p-2.5 border border-gray-600 rounded-lg shadow-sm focus:ring-gray-500 focus:border-gray-500 text-base bg-gray-700 text-gray-100 placeholder-gray-500 text-center" placeholder="Ex: 7">
            </div>

            <p id="motivationalMessage" class="text-lg text-green-400 font-semibold mb-4"></p> 
            
            <div class="mt-4 space-y-3 sm:space-y-0 sm:flex sm:space-x-3 justify-center"> 
                <button id="downloadPdfBtn" class="w-full sm:w-auto flex items-center justify-center font-semibold py-3 px-6 rounded-lg action-button button-3d text-base">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2">
                        <path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.235a.75.75 0 10-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.129V2.75z" />
                        <path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" />
                    </svg>
                    Salvar Resumo (PDF)
                </button>
                <button id="concludeAndGoHomeBtn" class="w-full sm:w-auto font-semibold py-3 px-6 rounded-lg action-button button-3d text-base">
                    Concluir e Voltar para Home
                </button>
            </div>
            <p class="text-sm text-gray-400 mt-4 text-center">Salve os dados de hoje e acompanhe sua melhora desde o último treino.</p>
        </div>

        <div id="loadingOverlay" class="force-hidden">
            Carregando Treino...
        </div>
    </div>

    <div id="toastNotification" class="toast">Mensagem!</div>

    <script>
        // --- CONSTANTES ---
        const ANIMATION_DURATION = 300; 

        // --- ESTADO DA APLICAÇÃO ---
        let currentUser = { name: null, email: null }; 
        let userProgressData = [];
        let currentScreen = '';
        let selectedLevel = '';
        let selectedWorkoutName = '';
        let workoutFlow = []; // Array de exercícios e supersets
        let currentStepIndex = 0; // Índice atual em workoutFlow
        let currentSeriesNumber = 1;
        let performanceData = []; // Mantém os dados individuais
        let workoutPSE = null;
        let restTimerInterval;
        let restTimerSeconds = 0;
        let totalRestDuration = 0;
        let restTimerRunning = false;
        let workoutStartTime = null;

        const Screens = {
            LOGIN: 'loginScreen', HOME: 'homeScreen', WORKOUT_LIST: 'workoutListScreen',
            WORKOUT_PREVIEW: 'workoutPreviewScreen', // Nova tela de prévia
            WORKOUT_EXECUTION: 'workoutExecutionScreen', SUMMARY: 'summaryScreen'
        };
        const ALL_SCREENS = Object.values(Screens);

        // --- REFERÊNCIAS A ELEMENTOS DOM ---
        let fixedHeaderElement, loadingOverlayElement, workoutButtonsContainerElement, 
            summaryContentElement, statsDivElement, motivationalMessageElement, 
            toastNotificationElement, loginNameInputElement, loginPasswordInputElement,
            pseInputElement, downloadPdfBtnElement, concludeAndGoHomeBtnElement, 
            exerciseContainerElement; 


        // --- FUNÇÕES DE INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            fixedHeaderElement = document.getElementById('fixedHeader');
            loadingOverlayElement = document.getElementById('loadingOverlay');
            workoutButtonsContainerElement = document.getElementById('workoutButtonsContainer');
            exerciseContainerElement = document.getElementById('exerciseContainer');
            summaryContentElement = document.getElementById('workoutSummaryContent');
            statsDivElement = document.getElementById('workoutStats');
            motivationalMessageElement = document.getElementById('motivationalMessage');
            toastNotificationElement = document.getElementById('toastNotification');
            loginNameInputElement = document.getElementById('loginName');
            loginPasswordInputElement = document.getElementById('loginPassword');
            pseInputElement = document.getElementById('pseInput'); 
            downloadPdfBtnElement = document.getElementById('downloadPdfBtn');
            concludeAndGoHomeBtnElement = document.getElementById('concludeAndGoHomeBtn');

            if (downloadPdfBtnElement) downloadPdfBtnElement.addEventListener('click', downloadSummaryAsPDF);
            if (concludeAndGoHomeBtnElement) concludeAndGoHomeBtnElement.addEventListener('click', concludeWorkoutAndGoHome);
            
            const startWorkoutBtn = document.getElementById('startWorkoutBtn');
            if(startWorkoutBtn) startWorkoutBtn.addEventListener('click', startWorkout);
            
            currentScreen = Screens.LOGIN; 
            showScreen(Screens.LOGIN); 
            console.warn("IMPORTANTE: A integração com Google Sheets agora está ativa. Verifique se a função doPost no seu script está configurada e implantada para salvar o progresso.");
        });

        // --- NAVEGAÇÃO E CONTROLE DE TELA ---
        function showScreen(screenId) {
            const currentScreenElement = document.getElementById(currentScreen); 
            const nextScreenElement = document.getElementById(screenId);    
            if (!nextScreenElement) { console.error(`Tela com ID '${screenId}' não encontrada.`); return; }
            if (currentScreenElement === nextScreenElement && !currentScreenElement.classList.contains('hidden')) { updateHeader(screenId); return; }
            if (currentScreenElement && currentScreenElement !== nextScreenElement) {
                currentScreenElement.classList.add('animate-slide-out-left');
                setTimeout(() => {
                    currentScreenElement.classList.add('hidden'); currentScreenElement.classList.remove('animate-slide-out-left');
                    nextScreenElement.classList.remove('hidden'); nextScreenElement.classList.add('animate-slide-in-right');
                    setTimeout(() => { nextScreenElement.classList.remove('animate-slide-in-right'); }, ANIMATION_DURATION);
                    currentScreen = screenId; window.scrollTo(0, 0); updateHeader(screenId);
                    if (screenId === Screens.SUMMARY) { displaySummary(); }
                }, ANIMATION_DURATION);
            } else { 
                ALL_SCREENS.forEach(id_ => {
                    const el = document.getElementById(id_);
                    if (el && id_ !== screenId) { el.classList.add('hidden'); el.classList.remove('animate-fade-in', 'animate-slide-in-right', 'animate-slide-out-left', 'animate-fade-out'); }
                });
                nextScreenElement.classList.remove('hidden'); nextScreenElement.classList.add('animate-fade-in');
                setTimeout(() => { nextScreenElement.classList.remove('animate-fade-in'); }, ANIMATION_DURATION);
                currentScreen = screenId; window.scrollTo(0, 0); updateHeader(screenId);
                if (screenId === Screens.SUMMARY) { displaySummary(); }
            }
        }

        function updateHeader(screenId) {
             if (!fixedHeaderElement) return;
            const fixedHeaderH1 = fixedHeaderElement.querySelector('h1');
            if (!fixedHeaderH1) { const newH1 = document.createElement('h1'); fixedHeaderElement.appendChild(newH1); }
            if (screenId === Screens.LOGIN || screenId === Screens.HOME) { fixedHeaderElement.classList.add('hidden'); } 
            else {
                fixedHeaderElement.classList.remove('hidden');
                let headerTitleText = `CALISTENIA <span class="pro-text-header">PRO</span>`; 
                let displayLevelName = selectedLevel;
                if (selectedLevel === 'avancado') displayLevelName = 'Avançado';
                else if (selectedLevel === 'intermediario') displayLevelName = 'Intermediário';
                else if (selectedLevel === 'iniciante') displayLevelName = 'Iniciante';
                else if (selectedLevel) displayLevelName = selectedLevel.charAt(0).toUpperCase() + selectedLevel.slice(1);
                else displayLevelName = ''; 
                if (screenId === Screens.WORKOUT_EXECUTION || screenId === Screens.SUMMARY || screenId === Screens.WORKOUT_PREVIEW) {
                    if (selectedWorkoutName && selectedLevel) { headerTitleText = `<span style="font-family: 'Inter', sans-serif; color: #cbd5e0; font-weight: 600; text-transform: none;">${selectedWorkoutName} <span class="text-lg font-normal">(${displayLevelName})</span></span>`; } 
                    else if (selectedWorkoutName) { headerTitleText = `<span style="font-family: 'Inter', sans-serif; color: #cbd5e0; font-weight: 600; text-transform: none;">${selectedWorkoutName}</span>`; }
                } else if (screenId === Screens.WORKOUT_LIST && selectedLevel) { headerTitleText = `<span style="font-family: 'Inter', sans-serif; color: #cbd5e0; font-weight: 600; text-transform: none;">Nível ${displayLevelName}</span>`; }
                const h1ToUpdate = fixedHeaderElement.querySelector('h1');
                if (h1ToUpdate) { h1ToUpdate.innerHTML = headerTitleText; }
            }
        }

        function resetAppState(resetUser = true) {
            clearRestTimer(); selectedLevel = ''; selectedWorkoutName = ''; workoutFlow = []; currentStepIndex = 0;
            currentSeriesNumber = 1; performanceData = []; workoutStartTime = null; workoutPSE = null; 
            if(document.getElementById('pseInput')) document.getElementById('pseInput').value = '';
            if (resetUser) { 
                currentUser = { name: null, email: null }; 
                if(loginNameInputElement) loginNameInputElement.value = '';
                if(loginPasswordInputElement) loginPasswordInputElement.value = '';
            }
        }

        function getCurrentPassword() {
            return "FORCA24"; 
        }

        function loginUser() {
            const name = loginNameInputElement?.value.trim();
            const password = loginPasswordInputElement?.value.trim();

            if (!name || !password) {
                showToast("Por favor, preencha seu nome e a senha de acesso.");
                return;
            }

            if (password !== getCurrentPassword()) {
                showToast("Senha de acesso incorreta. Verifique a senha do mês.");
                return;
            }

            currentUser.name = name;
            currentUser.email = null; 
            console.log("Usuário logado:", currentUser);
            showToast(`Bem-vindo(a), ${name}!`);
            showScreen(Screens.HOME); 
        }

        function selectLevel(level) {
            console.log(`Buscando treinos para o nível: ${level}`);
            selectedLevel = level;
        
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz_Hd7QqEfOO9_2k4abL-tyCiyQZzwVxEN63kluZkjNilgfsnhc6_HI-rjtNxdpcFYvFw/exec";
            const url = `${SCRIPT_URL}?action=getWorkouts&level=${encodeURIComponent(level)}`;
        
            showLoadingIndicator();
        
            fetch(url, {
                method: 'GET',
                mode: 'cors',
                redirect: 'follow'
            })
            .then(response => {
                if (!response.ok) { throw new Error(`Erro de rede: ${response.statusText}. Verifique as permissões do script.`); }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                displayWorkoutButtons(data);
            })
            .catch(error => {
                hideLoadingIndicator();
                console.error("Erro ao buscar lista de treinos:", error);
                showToast(error.message, 5000);
                workoutButtonsContainerElement.innerHTML = `<p class="text-center text-gray-400">Não foi possível carregar os treinos. Verifique a conexão e as permissões do script.</p>`;
                showScreen(Screens.WORKOUT_LIST);
            });
        }

        function displayWorkoutButtons(workouts) {
             if (!Array.isArray(workouts) || workouts.length === 0) {
                showToast(`Nenhum treino encontrado para o nível ${selectedLevel}.`);
                workoutButtonsContainerElement.innerHTML = `<p class="text-center text-gray-400">Nenhum treino cadastrado para este nível.</p>`;
                hideLoadingIndicator();
                showScreen(Screens.WORKOUT_LIST);
                return;
            }

            if (!workoutButtonsContainerElement) {
                console.error("Elemento workoutButtonsContainer não encontrado.");
                hideLoadingIndicator();
                return;
            }
            workoutButtonsContainerElement.innerHTML = ''; 

            workouts.forEach(workoutName => {
                const button = document.createElement('button');
                button.className = 'w-full font-semibold py-3 px-4 rounded-lg action-button button-3d'; 
                button.textContent = workoutName;
                button.addEventListener('click', () => loadWorkout(workoutName));
                workoutButtonsContainerElement.appendChild(button);
            });
            
            hideLoadingIndicator();
            showScreen(Screens.WORKOUT_LIST); 
        }
        
        async function loadWorkout(workoutName) {
            console.log(`Carregando treino: ${workoutName} para nível ${selectedLevel}`); selectedWorkoutName = workoutName;
            
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwNoVWfvR6iKcZ3iBIrPwOPH6ig9pF5uOitMceply-9EmLsI4nyfMYoMCBVVauARf1ukw/exec";
            if (SCRIPT_URL === "COLOQUE_O_ID_DA_SUA_PLANILHA_AQUI" || !SCRIPT_URL.startsWith("https://script.google.com/")) {
                showToast("Erro: URL do Script inválida ou não configurada.", 5000); console.error("URL do Script inválida ou não configurada:", SCRIPT_URL);
                return;
            }
            const url = `${SCRIPT_URL}?level=${encodeURIComponent(selectedLevel)}&workout=${encodeURIComponent(workoutName)}`;
            showLoadingIndicator();
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    let errorMsg = `Erro HTTP: ${response.status}`;
                    try { const errorData = await response.json(); errorMsg = errorData.error || errorMsg; } catch (parseError) { /* Ignora */ }
                    throw new Error(errorMsg);
                }
                const rawWorkoutData = await response.json();
                if (!Array.isArray(rawWorkoutData)) {
                     if (rawWorkoutData && rawWorkoutData.error) { throw new Error(rawWorkoutData.error); }
                     throw new Error("Resposta da API não é um array de exercícios.");
                }
                processWorkoutData(rawWorkoutData);
                hideLoadingIndicator();
                if (workoutFlow.length > 0) {
                    renderWorkoutPreview();
                    showScreen(Screens.WORKOUT_PREVIEW);
                } else { showToast(`Nenhum exercício encontrado para ${workoutName} (${selectedLevel}).`); }
            } catch (error) {
                hideLoadingIndicator(); console.error("Erro ao carregar treino:", error);
                showToast(`Erro ao carregar treino: ${error.message}`, 5000);
            }
        }
        
        function processWorkoutData(rawWorkoutData) {
            performanceData = rawWorkoutData.map(ex => ({
                exerciseId: ex.exercise_id || `exid_${Math.random().toString(36).substr(2, 9)}`, 
                exerciseName: ex.exercise_name || "Exercício Desconhecido", 
                seriesTargetCount: parseInt(ex.series) || 0,       
                repsTargetString: String(ex.reps || "N/A"), 
                restTimeString: String(ex.rest || "60"), 
                embedUrl: ex.embed_url || "",                       
                supersetId: ex.superset_id !== undefined ? String(ex.superset_id) : null, 
                seriesDone: []                                      
            }));
            workoutFlow = [];
            const supersetGroups = {};
            performanceData.forEach((ex) => {
                if (ex.supersetId) {
                    if (!supersetGroups[ex.supersetId]) {
                        supersetGroups[ex.supersetId] = [];
                    }
                    supersetGroups[ex.supersetId].push(ex);
                } else {
                    workoutFlow.push(ex); 
                }
            });
            Object.values(supersetGroups).forEach(group => {
                workoutFlow.push(group);
            });
        }
        
        function renderWorkoutPreview() {
            const previewContent = document.getElementById('previewContent');
            previewContent.innerHTML = `<h3 class="text-2xl font-bold mb-4 text-center text-gray-100">Prévia do Treino</h3>`;
            
            workoutFlow.forEach(step => {
                if (Array.isArray(step)) { // É um superset
                    const isWarmup = step[0]?.supersetId === '0';
                    const title = isWarmup ? "Aquecimento" : "Superset";
                    let supersetHtml = `<div class="p-3 bg-gray-800 rounded-lg mb-3">
                                            <p class="font-bold text-lg text-sky-400">${title}</p>
                                            <ul class="list-disc list-inside ml-4 mt-1 text-gray-300">`;
                    step.forEach(ex => {
                        supersetHtml += `<li>${ex.seriesTargetCount}x ${ex.exerciseName} (${ex.repsTargetString})</li>`;
                    });
                    supersetHtml += `</ul></div>`;
                    previewContent.innerHTML += supersetHtml;
                } else { // Exercício único
                     previewContent.innerHTML += `<div class="p-3 bg-gray-800 rounded-lg mb-3">
                                                    <p class="font-bold text-lg">${step.exerciseName}</p>
                                                    <p class="text-gray-300 ml-4">${step.seriesTargetCount}x ${step.repsTargetString}</p>
                                                </div>`;
                }
            });
        }

        function startWorkout() {
            workoutStartTime = Date.now();
            currentStepIndex = 0; 
            currentSeriesNumber = 1; 
            displayCurrentStep(); 
            showScreen(Screens.WORKOUT_EXECUTION);
        }

        function showLoadingIndicator() { if(loadingOverlayElement) loadingOverlayElement.classList.remove('force-hidden'); }
        function hideLoadingIndicator() { if(loadingOverlayElement) loadingOverlayElement.classList.add('force-hidden'); }

        function displayCurrentStep() {
            if (!workoutFlow || currentStepIndex >= workoutFlow.length) { finishWorkout(); return; }
            exerciseContainerElement.innerHTML = ''; 
            const currentStep = workoutFlow[currentStepIndex];
            if(Array.isArray(currentStep)) { 
                renderSuperset(currentStep);
            } else { 
                renderSingleExercise(currentStep);
            }
        }

        function renderSuperset(supersetGroup) {
            const isWarmup = supersetGroup[0]?.supersetId === '0';
            const title = isWarmup ? "AQUECIMENTO" : "SUPERSET";
            const mainButtonText = isWarmup ? "Aquecimento Concluído" : "Descansar";
            
            let html = `<div class="text-center">
                            <h3 class="series-display-text text-2xl uppercase">${title}</h3>
                            <p class="series-display-text text-2xl mb-4">SÉRIE ${currentSeriesNumber}</p>
                        </div>
                        <div id="supersetExercisesContainer" class="space-y-8">`;
            supersetGroup.forEach((exercise, index) => {
                html += `
                    <div class="superset-exercise-block">
                        <p class="font-semibold text-lg text-white mb-2 text-center">${exercise.exerciseName}</p>
                        <div class="media-display-area mb-3">
                           <div class="video-container">
                                <iframe src="${exercise.embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                           </div>
                        </div>
                        <div class="text-center !my-2">
                            <p class="text-base text-gray-200">Repetições alvo: <strong class="font-bold">${exercise.repsTargetString}</strong></p>
                        </div>
                        ${!isWarmup ? `
                        <div class="px-2">
                             <label class="block text-sm font-medium text-gray-400 mb-1 text-center">Sua performance (reps/tempo):</label>
                            <input type="text" class="w-full p-2.5 border border-gray-600 rounded-lg shadow-sm bg-gray-700 text-gray-100 placeholder-gray-500 text-center superset-reps-input" placeholder="Ex: 10 ou 30s (Opcional)" data-exercise-id="${exercise.exerciseId}">
                        </div>` : ''}
                    </div>
                    ${index < supersetGroup.length - 1 ? '<hr class="border-gray-700 my-6">' : ''}
                `;
            });
            html += `</div>`;
            if (!isWarmup) {
                 html += ` <div id="observationInputArea" class="px-2 mt-6">
                            <label for="observationInput" class="block text-sm font-medium text-gray-300 mb-1 text-center">Observações da Série (Opcional):</label>
                            <textarea id="observationInput" class="w-full p-2.5 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 placeholder-gray-500 text-center" rows="2"></textarea>
                        </div>`;
            }
            html += `<div id="exerciseActionButtons" class="mt-4 text-center">
                        <button id="completeSeriesBtn" onclick="completeStep()" class="w-full max-w-xs mx-auto font-semibold py-3 px-4 rounded-lg action-button button-3d text-base">${mainButtonText}</button>
                        <button id="skipExerciseBtn" onclick="skipStep()" class="w-full max-w-xs mx-auto skip-exercise-btn font-semibold py-2 px-4 rounded-lg action-button button-3d text-base mt-2">Pular Passo Atual</button>
                    </div>`;
            exerciseContainerElement.innerHTML = html;
        }

        function renderSingleExercise(exercise) {
             let html = `<div class="text-center">
                            <h3 class="series-display-text text-2xl uppercase">${exercise.exerciseName}</h3>
                            <p class="series-display-text text-2xl mb-4">SÉRIE ${currentSeriesNumber}</p>
                         </div>
                         <div class="media-display-area mb-3">
                           <div class="video-container">
                                <iframe src="${exercise.embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                           </div>
                        </div>
                        <div class="exercise-details-info text-center !my-2">
                            <p class="text-base">Repetições alvo: <strong>${exercise.repsTargetString}</strong></p>
                        </div>
                        <p id="currentExerciseTotalReps" class="text-center text-gray-300 text-sm mt-1 mb-2 font-semibold"></p>
                        <div id="seriesInputArea" class="px-2">
                            <label for="repsInput" class="block text-sm font-medium text-gray-300 mb-1 text-center">Sua performance (reps/tempo):</label>
                            <input type="text" id="repsInput" class="w-full p-2.5 border border-gray-600 rounded-lg shadow-sm bg-gray-700 text-gray-100 placeholder-gray-500 text-center" placeholder="Ex: 10 ou 30s (Opcional)">
                        </div>
                        <div id="observationInputArea" class="px-2 mt-3">
                            <label for="observationInput" class="block text-sm font-medium text-gray-300 mb-1 text-center">Observações da Série (Opcional):</label>
                            <textarea id="observationInput" class="w-full p-2.5 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 placeholder-gray-500 text-center" rows="2"></textarea>
                        </div>
                        <div id="exerciseActionButtons" class="mt-4 text-center">
                            <button id="completeSeriesBtn" onclick="completeStep()" class="w-full max-w-xs mx-auto font-semibold py-3 px-4 rounded-lg action-button button-3d text-base">Concluir Série</button>
                            <button id="skipExerciseBtn" onclick="skipStep()" class="w-full max-w-xs mx-auto skip-exercise-btn font-semibold py-2 px-4 rounded-lg action-button button-3d text-base mt-2">Pular Exercício Atual</button>
                        </div>`;
            exerciseContainerElement.innerHTML = html;
            displayCurrentExerciseTotalReps();
        }


        function displayCurrentExerciseTotalReps() {
            const totalRepsElement = document.getElementById('currentExerciseTotalReps');
            if (!totalRepsElement) return;

            const currentStep = workoutFlow[currentStepIndex];
            if(Array.isArray(currentStep)) { 
                totalRepsElement.classList.add('hidden');
                return;
            }

            const currentExPerf = currentStep;
            if (!currentExPerf || !Array.isArray(currentExPerf.seriesDone)) {
                totalRepsElement.classList.add('hidden');
                return;
            }
            
            let totalReps = 0;
            let hasAnyNumericReps = false;

            currentExPerf.seriesDone.forEach(serie => {
                if (serie && typeof serie.reps === 'string') {
                    const repsTrimmed = serie.reps.trim();
                    const repsNum = parseInt(repsTrimmed);
                    if (!isNaN(repsNum) && String(repsNum) === repsTrimmed) { 
                        totalReps += repsNum;
                        hasAnyNumericReps = true;
                    }
                }
            });

            if (hasAnyNumericReps) {
                totalRepsElement.textContent = `Total de Reps no Exercício: ${totalReps}`;
                totalRepsElement.classList.remove('hidden');
            } else {
                totalRepsElement.textContent = '';
                totalRepsElement.classList.add('hidden');
            }
        }


        function completeStep() {
            const currentStep = workoutFlow[currentStepIndex];
            const isWarmup = Array.isArray(currentStep) && currentStep[0].supersetId === '0';
            
            if (!isWarmup) {
                 const observationValue = exerciseContainerElement.querySelector('#observationInput')?.value.trim() || "";

                if (Array.isArray(currentStep)) { 
                    const repsInputs = exerciseContainerElement.querySelectorAll('.superset-reps-input');
                    repsInputs.forEach(input => {
                        const exerciseId = input.dataset.exerciseId;
                        const performanceEntry = performanceData.find(ex => ex.exerciseId === exerciseId);
                        if (performanceEntry) {
                            let repsValue = input.value.trim();
                            if (repsValue === "") { repsValue = "N/A"; }
                            performanceEntry.seriesDone.push({ reps: repsValue, observation: observationValue });
                        }
                    });

                } else { 
                    const repsInput = exerciseContainerElement.querySelector('#repsInput');
                    let repsValue = repsInput.value.trim();
                    if (repsValue === "") { repsValue = "N/A"; }
                    currentStep.seriesDone.push({ reps: repsValue, observation: observationValue });
                    displayCurrentExerciseTotalReps();
                }
            }
            
            const lastExerciseInStep = Array.isArray(currentStep) ? currentStep[currentStep.length - 1] : currentStep;
            const restTimeString = lastExerciseInStep.restTimeString;
            totalRestDuration = parseRestTime(restTimeString);

            const isLastSeries = currentSeriesNumber >= lastExerciseInStep.seriesTargetCount;
            const isLastStep = currentStepIndex === workoutFlow.length - 1;

            if (isLastSeries && isLastStep) {
                finishWorkout();
            } else if (isWarmup) {
                handleRestFinished(); // Pula direto para o próximo passo sem descanso
            } else {
                startRestTimer(totalRestDuration);
            }
        }
        
        function handleRestFinished() {
            const currentStep = workoutFlow[currentStepIndex];
            const seriesCount = Array.isArray(currentStep) ? currentStep[0].seriesTargetCount : currentStep.seriesTargetCount;
            
            currentSeriesNumber++;
            
            if (currentSeriesNumber > seriesCount) {
                currentStepIndex++;
                currentSeriesNumber = 1;
            }
            
            displayCurrentStep();
        }

        function skipStep() {
            const currentStep = workoutFlow[currentStepIndex];
            const observationText = "Exercício pulado";
            
            const processSkip = (exercise) => {
                 while (exercise.seriesDone.length < exercise.seriesTargetCount) {
                    exercise.seriesDone.push({ reps: "Pulado", observation: observationText });
                }
            };

            if(Array.isArray(currentStep)) { 
                currentStep.forEach(processSkip);
                showToast(`Superset pulado.`);
            } else { 
                processSkip(currentStep);
                showToast(`${currentStep.exerciseName} pulado.`);
            }
            
            const isLastStep = currentStepIndex === workoutFlow.length - 1;
            if(isLastStep) {
                finishWorkout();
            } else {
                currentStepIndex++;
                currentSeriesNumber = 1;
                displayCurrentStep();
                window.scrollTo(0, 0); 
            }
        }
        
        function updateSummaryStats() {
            if (!statsDivElement) return;
            const workoutEndTimeForDisplay = Date.now();
            const workoutDurationMsForDisplay = workoutStartTime ? workoutEndTimeForDisplay - workoutStartTime : 0;
            const durationSecondsForDisplay = Math.floor(workoutDurationMsForDisplay / 1000);
            const durationFormattedForDisplay = formatTime(durationSecondsForDisplay);
            let totalRepsOverallForDisplay = 0;
            const filteredData = performanceData.filter(ex => ex.supersetId !== '0');
            
            filteredData.forEach(ex => {
                ex.seriesDone.forEach(serie => {
                    if (serie.reps !== "Pulado (Exercício)" && serie.reps !== "Pulado" && serie.reps !== "N/A") {
                        const repsNumeric = parseInt(serie.reps);
                        if (!isNaN(repsNumeric)) { totalRepsOverallForDisplay += repsNumeric; }
                    }
                });
            });
            const registeredExercisesCountForDisplay = filteredData.filter(ex => ex.seriesDone.length > 0).length;
            statsDivElement.innerHTML = `
                <h3 class="text-xl font-semibold mb-2 text-blue-400" style="font-family: 'Inter', sans-serif;">Estatísticas Gerais</h3>
                <p><strong>Tempo Total de Treino:</strong> ${durationFormattedForDisplay}</p>
                <p><strong>Total de Repetições (numéricas):</strong> ${totalRepsOverallForDisplay > 0 ? totalRepsOverallForDisplay : "N/A"}</p>
                <p><strong>Exercícios com séries registradas:</strong> ${registeredExercisesCountForDisplay}</p>
            `;
        }

        function handleSummaryRepChange(event) {
            const inputElement = event.target;
            const exerciseId = inputElement.dataset.exerciseId;
            const seriesIndex = parseInt(inputElement.dataset.seriesIndex);
            const fieldType = inputElement.dataset.fieldType; 
            const newValue = inputElement.value.trim();
            
            const exerciseToUpdate = performanceData.find(ex => ex.exerciseId === exerciseId);

            if (exerciseToUpdate && exerciseToUpdate.seriesDone[seriesIndex]) {
                if (fieldType === 'reps') {
                    exerciseToUpdate.seriesDone[seriesIndex].reps = newValue === "" ? "N/A" : newValue;
                    showToast(`Repetições da Série ${seriesIndex + 1} do Exercício "${exerciseToUpdate.exerciseName}" atualizadas para ${newValue}.`, 2500);
                } else if (fieldType === 'observation') {
                    exerciseToUpdate.seriesDone[seriesIndex].observation = newValue;
                     showToast(`Observação da Série ${seriesIndex + 1} do Exercício "${exerciseToUpdate.exerciseName}" atualizada.`, 2500);
                }
                updateSummaryStats(); 
            }
        }


        function finishWorkout() { if(document.getElementById('pseInput')) document.getElementById('pseInput').value = ''; showScreen(Screens.SUMMARY); }

        async function concludeWorkoutAndGoHome() {
            const pseValue = document.getElementById('pseInput')?.value ? parseInt(document.getElementById('pseInput').value) : null;
            if (document.getElementById('pseInput') && pseValue !== null && (pseValue < 1 || pseValue > 10 || isNaN(pseValue))) {
                showToast("PSE inválido. Por favor, insira um valor numérico entre 1 e 10.", 4000);
                document.getElementById('pseInput').focus(); return; 
            }
            workoutPSE = pseValue; userProgressData = []; 
            const studentName = currentUser.name || "Convidado"; const studentEmail = currentUser.email || "N/A"; 
            const date = new Date().toISOString(); const workoutEndTime = Date.now();
            const workoutDurationMs = workoutStartTime ? workoutEndTime - workoutStartTime : 0;
            const workoutDurationSec = Math.floor(workoutDurationMs / 1000);
            
            const filteredData = performanceData.filter(ex => ex.supersetId !== '0');
            filteredData.forEach(exercisePerf => {
                if (exercisePerf.seriesDone.length === 0) { 
                    userProgressData.push({
                        date: date, studentName: studentName, studentEmail: studentEmail,
                        level: selectedLevel, workoutName: selectedWorkoutName,
                        exerciseName: exercisePerf.exerciseName, exerciseId: exercisePerf.exerciseId,
                        seriesNumber: 0, repsDone: "Pulado (Exercício)", observation: "", 
                        workoutDurationSec: workoutDurationSec, pse: workoutPSE 
                    });
                } else {
                    exercisePerf.seriesDone.forEach((seriesData, index) => {
                        userProgressData.push({
                            date: date, studentName: studentName, studentEmail: studentEmail,
                            level: selectedLevel, workoutName: selectedWorkoutName,
                            exerciseName: exercisePerf.exerciseName, exerciseId: exercisePerf.exerciseId,
                            seriesNumber: index + 1, repsDone: seriesData.reps,
                            observation: seriesData.observation || "", 
                            workoutDurationSec: workoutDurationSec, pse: workoutPSE 
                        });
                    });
                }
            });
            console.log("Dados a serem enviados para a planilha (após concluir):", userProgressData);
            showToast(`Salvando ${selectedWorkoutName} na planilha...`);
            const saveSuccess = await saveProgressToSheet(userProgressData);
            if (saveSuccess) { 
                showToast(`Treino ${selectedWorkoutName} salvo na planilha com sucesso!`); 
            }
            showScreen(Screens.HOME); resetAppState(true); 
        }
        
        async function downloadSummaryAsPDF() {
            const { jsPDF } = window.jspdf; 
            
            const pdfContainer = document.createElement('div');
            pdfContainer.style.fontFamily = "'Inter', sans-serif";
            pdfContainer.style.backgroundColor = '#ffffff'; 
            pdfContainer.style.color = '#333333'; 
            pdfContainer.style.padding = '20px';
            pdfContainer.style.width = '210mm'; 
            pdfContainer.style.boxSizing = 'border-box';

            let pdfHtml = `<div style="text-align: center; margin-bottom: 20px;">
                                <h1 style="font-family: 'Archivo Black', sans-serif; font-size: 24px; color: #121212; margin-bottom: 5px;">CALISTENIA PRO - RESUMO DO TREINO</h1>
                                <p style="font-size: 14px; color: #555555; margin-bottom: 3px;"><strong>Aluno:</strong> ${currentUser.name || "Convidado"}</p>
                                <p style="font-size: 14px; color: #555555; margin-bottom: 3px;"><strong>Treino:</strong> ${selectedWorkoutName || "N/A"} (${selectedLevel ? selectedLevel.charAt(0).toUpperCase() + selectedLevel.slice(1) : 'N/A'})</p>
                                <p style="font-size: 14px; color: #555555;"><strong>Data:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
                           </div>`;
            
            pdfHtml += `<hr style="border-top: 1px solid #ccc; margin: 15px 0;">`;
            pdfHtml += `<h2 style="font-size: 18px; color: #121212; margin-bottom: 10px; font-weight: bold;">Desempenho Detalhado:</h2>`;
            const filteredDataForPdf = performanceData.filter(ex => ex.supersetId !== '0');

            filteredDataForPdf.forEach(exPerf => {
                let exerciseTotalReps = 0;
                let allSeriesAreNumericOrSpecialForPdf = true; 
                let hasAnyNumericRepsForPdf = false; 

                exPerf.seriesDone.forEach(serie => {
                    if (serie && typeof serie.reps === 'string') {
                        const repsTrimmed = serie.reps.trim();
                        const repsNum = parseInt(repsTrimmed);
                        if (!isNaN(repsNum) && String(repsNum) === repsTrimmed) {
                            exerciseTotalReps += repsNum;
                            hasAnyNumericRepsForPdf = true;
                        } else if (repsTrimmed !== "Pulado" && repsTrimmed !== "N/A" && repsTrimmed !== "") {
                            allSeriesAreNumericOrSpecialForPdf = false; 
                        }
                    } else if (serie) { 
                        allSeriesAreNumericOrSpecialForPdf = false;
                    }
                });

                let totalForExerciseBlock = "";
                if (allSeriesAreNumericOrSpecialForPdf && hasAnyNumericRepsForPdf) {
                    totalForExerciseBlock = `<p style="font-size: 15px; color: #333333; font-weight: bold; white-space: nowrap; margin-left: 10px;">Total: ${exerciseTotalReps}</p>`;
                }

                pdfHtml += `<div style="margin-bottom: 15px; padding: 10px; background-color: #f9f9f9; border: 1px solid #eeeeee; border-radius: 5px;">`;
                pdfHtml +=    `<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">`;
                pdfHtml +=        `<h3 style="font-size: 16px; color: #333333; font-weight: bold; flex-grow: 1;">${exPerf.exerciseName} <span style="font-size: 12px; color: #777777; font-weight: normal;">(Alvo: ${exPerf.repsTargetString})</span></h3>`;
                pdfHtml +=        totalForExerciseBlock; 
                pdfHtml +=    `</div>`; 
                
                if (exPerf.seriesDone.length > 0) {
                    pdfHtml += `<ul style="list-style-type: none; padding-left: 0; margin-top: 0px;">`;
                    exPerf.seriesDone.forEach((serie, index) => {
                        pdfHtml += `<li style="font-size: 15px; color: #555555; margin-bottom: 4px;"><strong>Série ${index + 1}:</strong> ${serie.reps}`;
                        if(serie.observation && serie.observation.trim() !== "") {
                            pdfHtml += ` <em style="font-size: 13px; color: #777777;">(${serie.observation})</em>`;
                        }
                        pdfHtml += `</li>`;
                    });
                    pdfHtml += `</ul>`;
                } else {
                    pdfHtml += `<p style="font-size: 15px; color: #777777; margin-top: 5px;">Nenhuma série registrada.</p>`;
                }
                pdfHtml += `</div>`;
            });
            
            pdfHtml += `<hr style="border-top: 1px solid #ccc; margin: 15px 0;">`;
            pdfHtml += `<h2 style="font-size: 18px; color: #121212; margin-bottom: 10px; font-weight: bold;">Estatísticas Gerais:</h2>`;
             const workoutEndTime = Date.now();
             const workoutDurationMs = workoutStartTime ? workoutEndTime - workoutStartTime : 0;
             const durationSeconds = Math.floor(workoutDurationMs / 1000);
             const durationFormatted = formatTime(durationSeconds);
             let totalRepsOverall = 0;
             filteredDataForPdf.forEach(ex => { ex.seriesDone.forEach(serie => { if (serie.reps !== "Pulado (Exercício)" && serie.reps !== "Pulado" && serie.reps !== "N/A") { const repsNum = parseInt(serie.reps); if (!isNaN(repsNum)) { totalRepsOverall += repsNum; } } }); });
             const registeredExercisesCount = filteredDataForPdf.filter(ex => ex.seriesDone.length > 0).length;

            pdfHtml += `<div style="font-size: 14px; color: #555555; line-height: 1.6;">
                            <p><strong>Tempo Total de Treino:</strong> ${durationFormatted}</p>
                            <p><strong>Total de Repetições (numéricas):</strong> ${totalRepsOverall > 0 ? totalRepsOverall : "N/A"}</p>
                            <p><strong>Exercícios com séries registradas:</strong> ${registeredExercisesCount}</p>
                        </div>`;

            const pseValueForPdf = document.getElementById('pseInput')?.value;
            if (pseValueForPdf && pseValueForPdf.trim() !== "") {
                 pdfHtml += `<hr style="border-top: 1px solid #ccc; margin: 15px 0;">`;
                 pdfHtml += `<h2 style="font-size: 18px; color: #121212; margin-bottom: 10px; font-weight: bold;">Percepção de Esforço (PSE):</h2>`;
                 pdfHtml += `<p style="font-size: 15px; color: #555555;"><strong>Sua PSE (1-10):</strong> ${pseValueForPdf}</p>`;
            }

            pdfContainer.innerHTML = pdfHtml;
            pdfContainer.style.position = 'absolute';
            pdfContainer.style.left = '-9999px'; 
            document.body.appendChild(pdfContainer);

            showToast("Gerando PDF...", 2000);

            try {
                const canvas = await html2canvas(pdfContainer, {
                    scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff' 
                });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const margin = 15; 
                const contentWidth = pdfWidth - (2 * margin);
                const imgProps = pdf.getImageProperties(imgData);
                const imgRatio = imgProps.width / imgProps.height;
                let newImgHeight = contentWidth / imgRatio;
                let newImgWidth = contentWidth;
                if (newImgHeight > (pdfHeight - (2*margin))) {
                    newImgHeight = pdfHeight - (2*margin); newImgWidth = newImgHeight * imgRatio;
                }
                pdf.addImage(imgData, 'PNG', margin, margin, newImgWidth, newImgHeight);
                pdf.save(`resumo_treino_${selectedWorkoutName.replace(/\s+/g, '_')}_${currentUser.name.replace(/\s+/g, '_')}_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`);
                showToast("PDF gerado com sucesso!", 3000);
            } catch (error) {
                console.error("Erro ao gerar PDF:", error);
                showToast("Erro ao gerar PDF. Verifique o console.", 4000);
            } finally {
                document.body.removeChild(pdfContainer); 
            }
        }


        async function saveProgressToSheet(progressDataArray) {
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwwkxK_TGT2u5ngiSxcKTIFJJFePZZMX90QE05DBoNQv1l8Ak_LcO1A9xddsvusl1r63Q/exec"; 
            if (SCRIPT_URL === "COLOQUE_O_ID_DA_SUA_PLANILHA_AQUI" || !SCRIPT_URL.startsWith("https://script.google.com/")) {
                console.error("URL do Script inválida ou não configurada para salvar."); return false;
            }
            if (!progressDataArray || progressDataArray.length === 0) { console.log("Nenhum dado de progresso para salvar."); return true; }
            try {
                for (const progressEntry of progressDataArray) {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST', mode: 'cors', cache: 'no-cache',
                        headers: { 'Content-Type': 'application/json', },
                        redirect: 'follow', body: JSON.stringify(progressEntry)
                    });
                    if (response.type === 'error' || (response.status !== 200 && response.status !== 302 && response.status !== 0) ) { 
                        let errorMsg = `Erro ao salvar dados. Status: ${response.status}`;
                        try { const errorData = await response.json(); errorMsg = errorData.message || errorData.error || errorMsg;} catch(e) { /* ignora */ }
                        console.error("Falha ao salvar progresso:", errorMsg, "Entrada:", progressEntry);
                    }
                    await new Promise(resolve => setTimeout(resolve, 50)); 
                }
                console.log("Todas as entradas de progresso foram enviadas (ou tentativas foram feitas)."); return true;
            } catch (error) {
                console.error("Erro de rede ou na função saveProgressToSheet:", error);
                // showToast(`Erro de rede ao salvar: ${error.message}`, 5000); // Removido
                return false;
            }
        }

        function displaySummary() { 
            if (!summaryContentElement || !statsDivElement || !motivationalMessageElement) {
                 console.error("Elementos da tela de resumo não encontrados."); return;
            }
            const studentName = currentUser.name || "Convidado"; const date = new Date().toLocaleDateString('pt-BR');
            let displayLevelName = selectedLevel;
            if (selectedLevel === 'avancado') displayLevelName = 'Avançado';
            else if (selectedLevel === 'intermediario') displayLevelName = 'Intermediário';
            else if (selectedLevel === 'iniciante') displayLevelName = 'Iniciante';
            else if (selectedLevel) displayLevelName = selectedLevel.charAt(0).toUpperCase() + selectedLevel.slice(1);
            else displayLevelName = 'N/A';

            summaryContentElement.innerHTML = `
                <p><strong>Aluno:</strong> ${studentName}</p>
                <p><strong>Data:</strong> ${date}</p>
                <p><strong>Nível:</strong> ${displayLevelName}</p>
                <p><strong>Treino:</strong> ${selectedWorkoutName || 'N/A'}</p>
                <hr class="my-3 border-gray-600">
                <h4 class="font-semibold mb-2 text-xl text-gray-200" style="font-family: 'Inter', sans-serif;">Desempenho Detalhado:</h4>
            `;
            const filteredData = performanceData.filter(ex => ex.supersetId !== '0');

            if (filteredData.length === 0) {
                 summaryContentElement.innerHTML += `<p class="text-gray-400">Nenhum exercício foi registrado neste treino.</p>`;
            }
            filteredData.forEach((exPerf, exercisePerfIndex) => {
                const exerciseDiv = document.createElement('div');
                exerciseDiv.className = 'mb-3 p-3 bg-gray-800 rounded-md shadow-sm';
                const repsTargetDisplay = `(Alvo: ${exPerf.repsTargetString})`;
                exerciseDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <p class="font-medium text-gray-100">${exPerf.exerciseName} <span class="text-sm text-gray-400">${repsTargetDisplay}</span></p>
                    </div>`;
                if (exPerf.seriesDone.length > 0) {
                    const seriesList = document.createElement('ul');
                    seriesList.className = 'mt-2 space-y-2'; 
                    exPerf.seriesDone.forEach((serie, seriesIndex) => {
                        const seriesItemLi = document.createElement('div');
                        seriesItemLi.className = 'flex items-center space-x-2'
                        
                        const seriesLabel = document.createElement('span');
                        seriesLabel.className = 'text-sm text-gray-300 w-16';
                        seriesLabel.textContent = `Série ${seriesIndex + 1}:`;
                        seriesItemLi.appendChild(seriesLabel);
                        
                        const repInput = document.createElement('input');
                        repInput.type = 'text'; repInput.value = serie.reps;
                        repInput.className = 'p-1.5 border border-gray-600 rounded-md bg-gray-700 text-gray-100 w-24 text-center text-sm shadow-sm focus:ring-sky-500 focus:border-sky-500 placeholder-gray-500';
                        repInput.dataset.exerciseId = exPerf.exerciseId; 
                        repInput.dataset.seriesIndex = seriesIndex;
                        repInput.dataset.fieldType = "reps"; 
                        repInput.placeholder = "Reps"; repInput.addEventListener('change', handleSummaryRepChange);
                        seriesItemLi.appendChild(repInput);

                        const obsInput = document.createElement('textarea');
                        obsInput.value = serie.observation || "";
                        obsInput.className = 'flex-grow p-1.5 border border-gray-600 rounded-md bg-gray-700 text-gray-100 text-sm placeholder-gray-500 focus:ring-sky-500 focus:border-sky-500';
                        obsInput.rows = "1";
                        obsInput.placeholder = "Observação (opcional)";
                        obsInput.dataset.exerciseId = exPerf.exerciseId;
                        obsInput.dataset.seriesIndex = seriesIndex;
                        obsInput.dataset.fieldType = "observation"; 
                        obsInput.addEventListener('change', handleSummaryRepChange);
                        seriesItemLi.appendChild(obsInput);
                        
                        seriesList.appendChild(seriesItemLi);
                    });
                    exerciseDiv.appendChild(seriesList);
                } else {
                     exerciseDiv.innerHTML += `<p class="text-sm text-gray-400 mt-1">Nenhuma série registrada para este exercício.</p>`;
                }
                summaryContentElement.appendChild(exerciseDiv);
            });
            updateSummaryStats(); 
            motivationalMessageElement.textContent = `Parabéns, ${studentName}! Você mandou bem no ${selectedWorkoutName || 'treino'}! Revise seu resumo e adicione sua PSE.`;
            if(pseInputElement) pseInputElement.focus(); 
        }

        // --- TIMERS ---
        function parseRestTime(restString) {
            if (!restString || typeof restString !== 'string') return 60; 
            restString = restString.trim();
            const minSecMatch = restString.match(/^(?:(\d+)')?(?:(\d+)"?)?$/);
            if (minSecMatch) {
                const minutes = parseInt(minSecMatch[1]) || 0; const seconds = parseInt(minSecMatch[2]) || 0;
                if (minutes > 0 || seconds > 0) return (minutes * 60) + seconds;
            }
            const rangeMinMatch = restString.match(/^(\d+)\s*-\s*(\d+)\s*'/);
            if (rangeMinMatch) {
                const minM = parseInt(rangeMinMatch[1]); const maxM = parseInt(rangeMinMatch[2]);
                return Math.round(((minM * 60) + (maxM * 60)) / 2);
            }
            const rangeSecMatch = restString.match(/^(\d+)\s*-\s*(\d+)\s*"/);
            if (rangeSecMatch) {
                const minS = parseInt(rangeSecMatch[1]); const maxS = parseInt(rangeSecMatch[2]);
                return Math.round((minS + maxS) / 2);
            }
            const simpleSecondsMatch = restString.match(/^(\d+)$/);
            if (simpleSecondsMatch) return parseInt(simpleSecondsMatch[1]);
            return 60;
        }

        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60); const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function setProgress(percent) {
             const progressRing = document.getElementById('progressRing');
             if (progressRing) {
                const radius = progressRing.r.baseVal.value;
                const circumference = 2 * Math.PI * radius;
                progressRing.style.strokeDasharray = `${circumference} ${circumference}`;
                const offset = circumference - (percent / 100) * circumference;
                progressRing.style.strokeDashoffset = offset;
             }
        }

        function startRestTimer(durationInSeconds) {
            clearRestTimer();
            restTimerSeconds = durationInSeconds;
            totalRestDuration = durationInSeconds;
            restTimerRunning = true;

            const timerHtml = `
                <div class="text-center">
                    <h3 class="series-display-text text-2xl mb-4">DESCANSO</h3>
                </div>
                <div class="flex items-center justify-center">
                    <div class="timer-display-and-controls">
                        <button id="skipRestTimerBtn" onclick="skipRest()" class="action-button">Pular</button>
                        <div id="circularTimerContainer" class="relative">
                            <svg class="w-full h-full" viewBox="0 0 100 100">
                                <circle class="text-gray-700" stroke-width="8" stroke="currentColor" fill="transparent" r="42" cx="50" cy="50"/>
                                <circle id="progressRing" class="text-sky-400" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="42" cx="50" cy="50" style="transform: rotate(-90deg); transform-origin: 50% 50%;"/>
                            </svg>
                            <div id="circularTimerText" class="absolute inset-0 flex items-center justify-center text-3xl font-bold text-gray-100"></div>
                        </div>
                        <button id="pauseRestTimerBtn" onclick="pauseRestTimer()" class="action-button">Pausar</button>
                    </div>
                </div>`;
            
            exerciseContainerElement.innerHTML = timerHtml;
            const circularTimerTextElement = document.getElementById('circularTimerText');
            circularTimerTextElement.textContent = formatTime(restTimerSeconds);
            setProgress(0); 

            restTimerInterval = setInterval(() => {
                restTimerSeconds--;
                if (circularTimerTextElement) circularTimerTextElement.textContent = formatTime(restTimerSeconds);

                const percentCompleted = totalRestDuration > 0 ? ((totalRestDuration - restTimerSeconds) / totalRestDuration) * 100 : 0;
                setProgress(percentCompleted);

                if (restTimerSeconds < 0) {
                    clearRestTimer();
                    showToast("Descanso finalizado!");
                    handleRestFinished();
                }
            }, 1000);
        }

        function pauseRestTimer() {
            const pauseBtn = document.getElementById('pauseRestTimerBtn'); if (!pauseBtn) return;
            if (restTimerRunning) {
                restTimerRunning = false; clearInterval(restTimerInterval); pauseBtn.textContent = 'Retomar';
            } else {
                if (restTimerSeconds >= 0) { 
                    restTimerRunning = true; pauseBtn.textContent = 'Pausar';
                    restTimerInterval = setInterval(() => {
                        restTimerSeconds--; 
                        const circularTimerTextElement = document.getElementById('circularTimerText');
                        if(circularTimerTextElement) circularTimerTextElement.textContent = formatTime(restTimerSeconds);
                        const percentCompleted = totalRestDuration > 0 ? ((totalRestDuration - restTimerSeconds) / totalRestDuration) * 100 : 0;
                        setProgress(percentCompleted);
                        if (restTimerSeconds < 0) { clearRestTimer(); showToast("Descanso finalizado!"); handleRestFinished(); }
                    }, 1000);
                }
            }
        }

        function skipRest() { clearRestTimer(); showToast("Descanso pulado."); handleRestFinished(); }
        function clearRestTimer() { clearInterval(restTimerInterval); restTimerRunning = false; }

        // --- UTILITÁRIOS ---
        function showToast(message, duration = 3000) {
             if (!toastNotificationElement) return;
            toastNotificationElement.textContent = message;
            toastNotificationElement.classList.remove('hide'); toastNotificationElement.classList.add('show');
            if (toastNotificationElement.toastTimeout) { clearTimeout(toastNotificationElement.toastTimeout); }
            toastNotificationElement.toastTimeout = setTimeout(() => {
                toastNotificationElement.classList.remove('show'); toastNotificationElement.classList.add('hide');
            }, duration);
        }
    </script>
</body>
</html>
